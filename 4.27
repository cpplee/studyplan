#主主复制   vim /etc/my.cnf


在4.26主从复制上添加

#server id(从)
server-id=200

#bin-log(新增)
log-bin=mysql-bin
binlog-format=mixed

#relay log
relay-log=mysql-relay

#server id(主)
server-id=199

#bin-log
log-bin=mysql-bin
binlog-format=mixed

#relay log(新增)
relay-log=mysql-relay

systemctl restart mariadb.service #重启MariaDB
每次都要用show master status   查看mster_log_file与master_log_pos的值根据实际情况来判断
change master to
master_host='192.168.1.199', 
master_user='repl',
master_password='repl',
master_log_file='mysql-bin.000003',
master_log_pos=416




change master to
master_host='192.168.1.200', 
master_user='repl',
master_password='repl',
master_log_file='mysql-bin.000001',
master_log_pos=416
要注意主主复制的时候插入数据容易出现 (2个请求同时到达2台服务器)主键冲突

如果是2台可以让
一台服务器从 1,3,5,7
另一台是2,4,6,8

set session auto_increment_increment=2;#每步增长2
set session auto_increment_offset=1;#从1开始增长


set session auto_increment_increment=2;
set session auto_increment_offset=1;
set global auto_increment_increment=2;
set global auto_increment_offset =1;

set session auto_increment_increment=2;#每步增长2
set session auto_increment_offset=2;#从1开始增长


set session auto_increment_increment=2;
set session auto_increment_offset=2;
set global auto_increment_increment=2;
set global auto_increment_offset =2;


如果后期需要增加服务器,这个办法就有限制了

我们可以在业务逻辑上来解决
比如在racle有sequnce序列
序列每次访问,生成递增/递减的数据

以redis为例,我们可以专门构建一个global:userid

每次PHP插入Mysql前，incr->global:userid,得到一个不重复的userid


主主模式主要用在  防止主从模式的主服务器突然gg
然后这时候可以使用主主的另外一台


在主主复制的一台服务器中的my.cnf配置
read_only=1;

这个时候需要重启mariadb
systemctl restart mariadb.service;


2.在php代码中写主从定义，比如1个主2个从db类变量
在query里面进行语句判断,分别链接不同的mysql服务器

2.用集群中间件
比如官方的mysql_proxy
还有观察你的中间件 amoeba


